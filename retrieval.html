<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CTS URN Text Retriever</title>
    <script src="urns-lib.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #333; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="url"], textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { min-height: 100px; resize: vertical; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        #retrievedPassagesArea { margin-top: 15px; max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding:10px; background-color: #f9f9f9;}
        .passage-item { border-bottom: 1px solid #eee; padding: 8px 0; }
        .passage-item:last-child { border-bottom: none; }
        .passage-urn { font-weight: bold; color: #0056b3; display: block; margin-bottom: 3px; font-family: monospace; }
        .passage-text { color: #555; }
        .status { font-style: italic; color: #777; margin-bottom:10px; }
        .error { color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>
    <h1>CTS URN Text Retriever</h1>

    <div class="section">
        <h2>1. Load Corpus Data</h2>
        <label for="corpusUrl">Corpus URL (CEX format, pipe-delimited):</label>
        <input type="url" id="corpusUrl" value="https://raw.githubusercontent.com/neelsmith/complutensian-texts/main/cex-editions/lxxglosses.cex">
        <button onclick="fetchCorpusData()">Fetch Corpus</button>
        <div id="corpusStatus" class="status">Corpus not yet loaded.</div>
        <label for="rawCorpusData">Or paste CEX data here (first line will be skipped):</label>
        <textarea id="rawCorpusData" placeholder="urn:cts:namespace:work.id:1|Text for passage 1..."></textarea>
        <button onclick="loadPastedData()">Load Pasted Data</button>
    </div>

    <div class="section">
        <h2>2. Retrieve Passages</h2>
        <label for="retrievalUrn">Enter CTS URN for retrieval:</label>
        <input type="text" id="retrievalUrn" value="urn:cts:lxx:ps150.n4:1">
        <button onclick="retrieveAndDisplayPassages()">Retrieve Passages</button>
        <div id="retrievalStatus" class="status"></div>
        <div id="retrievedPassagesArea">
            <p>No passages retrieved yet.</p>
        </div>
    </div>

    <script>
        let corpusData = ""; // To store the fetched/pasted corpus text

        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return '';
            return unsafe
                 .toString()
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        async function fetchCorpusData() {
            const url = document.getElementById('corpusUrl').value;
            const statusEl = document.getElementById('corpusStatus');
            statusEl.textContent = "Fetching corpus...";
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                corpusData = await response.text();
                document.getElementById('rawCorpusData').value = corpusData; // Show in textarea
                statusEl.textContent = `Corpus loaded successfully (${corpusData.split('\n').length} lines). First line will be skipped on retrieval.`;
                statusEl.className = 'status';
            } catch (error) {
                console.error("Failed to fetch corpus:", error);
                statusEl.textContent = `Error fetching corpus: ${error.message}`;
                statusEl.className = 'status error';
                corpusData = "";
            }
        }

        function loadPastedData() {
            corpusData = document.getElementById('rawCorpusData').value;
            const statusEl = document.getElementById('corpusStatus');
            if (corpusData.trim() === "") {
                 statusEl.textContent = `Pasted data is empty.`;
                 statusEl.className = 'status error';
            } else {
                statusEl.textContent = `Pasted data loaded (${corpusData.split('\n').length} lines). First line will be skipped on retrieval.`;
                statusEl.className = 'status';
            }
        }

        function retrieveAndDisplayPassages() {
            const retrievalUrnString = document.getElementById('retrievalUrn').value;
            const passagesArea = document.getElementById('retrievedPassagesArea');
            const retrievalStatusEl = document.getElementById('retrievalStatus');
            
            retrievalStatusEl.textContent = "";
            passagesArea.innerHTML = ""; // Clear previous results

            if (corpusData.trim() === "") {
                retrievalStatusEl.textContent = "Error: Corpus data is not loaded.";
                retrievalStatusEl.className = 'status error';
                return;
            }

            if (!CTSURN.isValidCtsUrn(retrievalUrnString)) {
                retrievalStatusEl.textContent = `Error: The retrieval URN "${escapeHtml(retrievalUrnString)}" is not a valid CTS URN.`;
                retrievalStatusEl.className = 'status error';
                return;
            }

            try {
                const retrieved = CTSURN.retrievePassages(retrievalUrnString, corpusData);
                
                if (retrieved.length > 0) {
                    let html = `<h3>Retrieved Passages for ${escapeHtml(retrievalUrnString)} (${retrieved.length} found):</h3>`;
                    retrieved.forEach(item => {
                        html += `<div class="passage-item">
                                     <span class="passage-urn">${escapeHtml(item.urn)}</span>
                                     <span class="passage-text">${escapeHtml(item.text)}</span>
                                 </div>`;
                    });
                    passagesArea.innerHTML = html;
                } else {
                    passagesArea.innerHTML = `<p>No passages found matching "${escapeHtml(retrievalUrnString)}".</p>`;
                }
            } catch (e) {
                 console.error("Error during retrieval:", e);
                 retrievalStatusEl.textContent = `An unexpected error occurred during retrieval: ${e.message}`;
                 retrievalStatusEl.className = 'status error';
            }
        }

        // Automatically fetch default corpus on load
        window.onload = function() {
            fetchCorpusData(); 
            // You can also pre-fill example retrieval URNs or run a default retrieval
            // document.getElementById('retrievalUrn').value = 'urn:cts:lxx:gen.1:1';
        };
    </script>
</body>
</html>
