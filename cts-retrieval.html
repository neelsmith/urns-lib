<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CTS Text Retrieval Test</title>
    <script src="urn-lib.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #resultsTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #resultsTable th, #resultsTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #resultsTable th { background-color: #f2f2f2; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>CTS Text Retrieval</h1>
    <p>Enter a CTS URN to retrieve matching passages from the lxxglosses.cex corpus.</p>
    <p>Corpus URL: <a href="https://raw.githubusercontent.com/neelsmith/complutensian-texts/refs/heads/main/cex-editions/lxxglosses.cex" target="_blank">lxxglosses.cex</a></p>

    <div>
        <label for="searchUrn">Search CTS URN:</label>
        <input type="text" id="searchUrn" style="width: 60%;" value="urn:cts:comptex:lxxglosses.palette.v1:1">
        <button onclick="performRetrieval()">Retrieve Passages</button>
    </div>

    <div id="status" style="margin-top:10px;"></div>
    <div id="resultsContainer">
        <table id="resultsTable" style="display:none;">
            <thead><tr><th>Matched URN</th><th>Text Content</th></tr></thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>

    <script>
        let corpusData = null;
        const corpusUrl = 'https://raw.githubusercontent.com/neelsmith/complutensian-texts/refs/heads/main/cex-editions/lxxglosses.cex';
        // const corpusUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://raw.githubusercontent.com/neelsmith/complutensian-texts/refs/heads/main/cex-editions/lxxglosses.cex');


        async function fetchCorpus() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Loading corpus...';
            try {
                // Using a CORS proxy for local testing if direct fetch fails due to CORS
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(corpusUrl);
                const response = await fetch(proxyUrl); // Use proxyUrl for testing, corpusUrl for deployment if server has CORS
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                corpusData = await response.text();
                statusEl.textContent = 'Corpus loaded successfully. Ready to search.';
            } catch (error) {
                console.error('Error fetching corpus:', error);
                statusEl.innerHTML = `<span class="error">Failed to load corpus: ${error.message}. Ensure you are not blocked by CORS. Try a CORS proxy if needed.</span>`;
                corpusData = null; // Ensure it's null on failure
            }
        }

        function performRetrieval() {
            const searchUrnStr = document.getElementById('searchUrn').value;
            const statusEl = document.getElementById('status');
            const resultsTable = document.getElementById('resultsTable');
            const resultsBody = document.getElementById('resultsBody');

            resultsBody.innerHTML = ''; // Clear previous results
            resultsTable.style.display = 'none';

            if (!URNTools.isValidCtsUrn(searchUrnStr)) {
                statusEl.innerHTML = `<span class="error">Invalid search URN. Please enter a valid CTS URN.</span>`;
                return;
            }
            
            if (!corpusData) {
                statusEl.innerHTML = `<span class="error">Corpus data not loaded. Please wait or try reloading.</span>`;
                fetchCorpus(); // Attempt to load it again
                return;
            }

            statusEl.textContent = 'Searching...';
            try {
                const matches = URNTools.retrieveCtsPassages(searchUrnStr, corpusData);
                
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const row = resultsBody.insertRow();
                        const cell1 = row.insertCell();
                        const cell2 = row.insertCell();
                        cell1.textContent = match.urn;
                        cell2.textContent = match.text;
                    });
                    resultsTable.style.display = 'table';
                    statusEl.textContent = `Found ${matches.length} matching passage(s).`;
                } else {
                    statusEl.textContent = 'No matching passages found.';
                }
            } catch (e) {
                statusEl.innerHTML = `<span class="error">Error during retrieval: ${e.message}</span>`;
                console.error(e);
            }
        }
        
        function escapeHtml(unsafe) { // Re-add for safety, though textContent is safer
            if (unsafe === null || typeof unsafe === 'undefined') return '';
            return unsafe
                 .toString()
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Fetch corpus on page load
        fetchCorpus();
    </script>
</body>
</html>